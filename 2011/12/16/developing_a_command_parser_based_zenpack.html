<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="A collection of thoughts, discoveries, and ramblings I've bothered to document.">
        <meta name="viewport" content="width=device-width">
        <title>Developing a Command Parser Based ZenPack &mdash; Dave&#39;s Site</title>
            <link rel="stylesheet" href="../../../_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/main.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/modern5.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="../../../_static/webfont.css" type="text/css">
        <link rel="shortcut icon" href="../../../_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="../../../_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="../../../_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="../../../_static/plugins.js"></script>
        <script src="../../../_static/main.js"></script>
        <link rel="prev" title="Converting Zenoss VMWare Virtual Appliance to VirtualBox" href="../../../2012/02/10/converting_zenoss_vmware_virtual_appliance_to_virtualbox.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="../../../_static/underscore.js"></script><script type="text/javascript" src="../../../_static/doctools.js"></script><script type="text/javascript" src="../../../_static/disqus.js"></script><script type="text/javascript" src="../../../_static/google_analytics.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            // Adjusts document height if sidebar is taller
            var documentwrapper = document.getElementsByTagName("article")[0];
            var sidebar = document.getElementsByClassName("sidebar")[0];

            if (sidebar.offsetHeight > documentwrapper.offsetHeight)
            {
                var mainwrapper = document.getElementsByClassName("main")[0];
                documentwrapper.style.minHeight = mainwrapper.offsetHeight + "px";
            }

            // Scroll to content if on small screen
            if (screen.width < 480)
            {
                $(document).scrollTop(document.getElementsByTagName("article")[0].offsetTop - 44);
            }
        });
    </script></head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><header>
            <hgroup>
              <h1><a href="../../../index.html">Dave&#39;s Site</a></h1><h2>I Do Random Stuff And Occasionally Document It.</h2></hgroup>
          </header>
      <nav>
            <ul><li class="quicklink"><div class="rss">
        <a href="../../../rss.html" title="Subscribe via RSS"><span class="webfont">B</span></a>
    </div></li><li class="main-nav">
                  <a href="../../../index.html">Home</a>
                </li>
              <li class="main-nav">
                  <a href="../../../pages/about.html">About Me</a>
                </li>
              <li class="main-nav">
                  <a href="../../../pages/resume.html">Resume</a>
                </li>
              </ul>
          </nav><div class="main-container"><div class="main wrapper clearfix"><article><ul class="related clearfix">
            <li class="left"> &laquo; <a href="../../../2012/02/10/converting_zenoss_vmware_virtual_appliance_to_virtualbox.html">Converting Zenoss VMWare Virtual Appliance to VirtualBox</a></li>
            <li class="right"></li>
        </ul><div class="timestamp postmeta">
            <span>December 16, 2011</span>
        </div>
    <div class="section" id="developing-a-command-parser-based-zenpack">
<h1>Developing a Command Parser Based ZenPack</h1>
<div class="section" id="inspiration">
<h2>Inspiration</h2>
<p>I still consider myself a relative newb with Zenoss as well as Python development.
A while back I set out to write a custom <a class="reference external" href="http://github.com/dpetzel/ZenPacks.community.f5">ZenPack for use with F5 LTMs</a>. I never
would have been able to figure this out without the assistance of a great guide
written by Jane Curry. Her outstanding document can be found on the Zenoss
community site: <a class="reference external" href="http://community.zenoss.org/docs/DOC-10268">http://community.zenoss.org/docs/DOC-10268</a></p>
<p>I recently had a need for a ZenPack to interact with a couple of Varnish 3.x
servers. I scoured the net of course hoping someone had already done the work
for me, but no such luck. I did come across a few solutions for 2.x, but
from what I&#8217;ve been able to gather the interface to get these stats has changed some
(no more fetching stats over the management port). So I set out to write my own.</p>
<div id="more"> </div><p>I of course cracked Jane&#8217;s document open, but I quickly realized that it was very
SNMP-centric. This was perfect for the F5 pack as the device supports SNMP. However,
in this case SNMP is not an option. I&#8217;ve done enough research to know that what
I wanted to do is a custom Command Parser. The good news is that most of the concepts
from Jane&#8217;s doc still applied, the bad news is that the mechanics were going to be
very different.</p>
<p>I searched around a bit and I was able to find a few other ZenPacks that had taken
this approach, but I couldn&#8217;t find any &#8220;how-to&#8221; style documentation. As I mentioned
before I don&#8217;t consider myself a seasoned Python developer so for me reverse-engineering
someone&#8217;s else&#8217;s ZenPack would be a challenge. There is a small snippet of
information in the <a class="reference external" href="http://community.zenoss.org/community/documentation/official_documentation/zenoss-dev-guide">Zenoss Developer&#8217;s Guide</a>, but its far from a walk-through or
step-by-step guide like Jane&#8217;s document.</p>
<p>So I came to the sad realization that the approach was going to have to be looking
at what others had already done. So I figured I should probably document the process
and make it available to others in case they find themselves in a similar situation.</p>
</div>
<div class="section" id="conventions-and-assumptions">
<h2>Conventions and Assumptions</h2>
<p>Throughout this document I hope to link to existing documentation where it exists
so for things that are already covered elsewhere I will try and link to them, rather
than recreate similar documentation.</p>
<p>Nearly everything done from the command line on a Zenoss server should be done
while logged in as the Zenoss user (as opposed to root). Whenever I say <em>as the zenoss user</em>
that means:</p>
<div class="highlight-bash"><div class="highlight"><pre>ssh root@your_zenoss_server
su - zenoss
</pre></div>
</div>
<p>When it comes to breaking down code, I&#8217;m going to try and display the minimal
amount of code to make my point. Some of the files might have alot of extra
code that has nothing to do with the effort of writing a command parser. An
example of this would be all of the code needed to parse the output of <em>varnishstat</em>.
The mechanics of parsing the data and how its laid out is not within the scope of
this document. Its more important that we identify how we get to the point of
being able to parse the output, as well as how to take the parsed output
and use it to graph data. Since all the files we talk about are open source
and part of the ZenPack, it would be redundant to fully copy the contents of files
into this guide.</p>
</div>
<div class="section" id="lets-get-to-it">
<h2>Lets Get To It</h2>
<div class="section" id="create-your-empty-zenpack-shell">
<h3>Create Your Empty ZenPack Shell</h3>
<p>Creating an empty ZenPack is covered in numerous locations so I won&#8217;t dive into the
details here. If you don&#8217;t know how to create an empty shell, refer to section
3.2 of the <a class="reference external" href="http://community.zenoss.org/community/documentation/official_documentation/zenoss-dev-guide">Zenoss Developer&#8217;s Guide</a>. Additionally Jane&#8217;s
<a class="reference external" href="http://community.zenoss.org/docs/DOC-10268">Creating Zenoss ZenPacks for Zenoss 3</a> covers it in section 2.1.
In this case we will be creating <strong>ZenPacks.community.Varnish3</strong>.</p>
<p>Once the empty shell is created, you will certainly want to move it <em>out</em> of the
main ZenPack directory and into a seperate folder which we will put under
source control. My Zenoss development instance is running on a Virtual Box VM
and I store the files in a shared folder. This is personal preference,
feel free to put the files anywhere you want, just remember that every time I
reference &#8216;/media/zenpack_git_sources/ZenPacks.community.Varnish3/&#8217; you should
replace that with whatever folder you copied your pack out to. Here is what I ran
<em>as the zenoss user</em>:</p>
<div class="highlight-bash"><div class="highlight"><pre>cp -R <span class="nv">$ZENHOME</span>/ZenPacks/ZenPacks.community.Varnish3 /media/zenpack_git_sources/ZenPacks.community.Varnish3
zenpack --link --install<span class="o">=</span>/media/zenpack_git_sources/ZenPacks.community.Varnish3
zenoss restart
</pre></div>
</div>
<p>The full restart is arguably overkill, but I find knowing which situations require
restarting which daemons to be inconsistent so while it takes longer, I usually just
do a full restart rather than pick and choose which daemons to restart.</p>
</div>
<div class="section" id="initialize-a-new-git-repo-in-your-zenpack-folder">
<h3>Initialize a new GIT Repo in your ZenPack Folder</h3>
<p>As Zenoss seems to be making the move to GitHub as outlined in <a class="reference external" href="http://community.zenoss.org/docs/DOC-8495">ZenPack Development Process</a>
we are going to cooperate with that effort :) The <a class="reference external" href="http://community.zenoss.org/docs/DOC-8495">ZenPack Development Process</a>
document does a good job already of providing both abbreviated as well as in-depth
explanation of the process. For me I&#8217;ve got the GIT client on my Zenoss VM, rather
than my host PC, but since we are using shared folders it should work equally well
from either. Here is what I ran <em>as the zenoss user</em> to initialize the new repo:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">cd</span> /media/zenpack_git_sources/ZenPacks.community.Varnish3
git init
</pre></div>
</div>
<p>If this is the first time using git under the zenoss user login you need
probably need to setup your user name and email:</p>
<div class="highlight-bash"><div class="highlight"><pre>git config --global user.name <span class="s2">&quot;Firstname Lastname&quot;</span>
git config --global user.email <span class="s2">&quot;your_email@youremail.com&quot;</span>
</pre></div>
</div>
<p>Next I grabbed the &#8216;master&#8217; .gitignore file. Still <em>as the zenoss user</em>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">cd</span> /media/zenpack_git_sources/ZenPacks.community.Varnish3
wget https://raw.github.com/zenoss/Community-ZenPacks-SubModules/master/.gitignore
</pre></div>
</div>
<p>Additionally I use Eclipse with the pydev module on my PC as my IDE. As a result
there are a couple of extra files we will want to add to the .gitignore file.
If you use some other IDE (or none at all) you can skip the following lines.
Still <em>as the zenoss user</em>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">cd</span> /media/zenpack_git_sources/ZenPacks.community.Varnish3
<span class="nb">echo</span> .pydevproject &gt;&gt; .gitignore
<span class="nb">echo</span> .project &gt;&gt; .gitignore
</pre></div>
</div>
<p>Now add everything and do a commit. You should note that this commit does <strong>not</strong>
push anything up to GitHub, it simply commits the files into your local repo.
Once again, run the following <em>as the zenoss user</em>:</p>
<div class="highlight-bash"><div class="highlight"><pre>git add -A
git status
git commit -m <span class="s1">&#39;Commiting the initial empty shell&#39;</span>
</pre></div>
</div>
<p>At this point we&#8217;ve done the following:</p>
<ul class="simple">
<li>Created the empty ZenPack shell</li>
<li>We&#8217;ve relocated it outside of Zenoss installation directory</li>
<li>We&#8217;ve initialized a new <em>local</em> GIT repository</li>
<li>Added a few IDE specific files that should be ignored from source control</li>
<li>Committed everything.</li>
</ul>
<p>Now comes the fun part... figuring out how to actually write this crazy thing:)</p>
</div>
<div class="section" id="identifying-the-pieces">
<h3>Identifying The Pieces</h3>
<p>Before we get to far, its important to understand what items we want to include
in this ZenPack. This is where it starts to get dicey if you don&#8217;t know some of the
inner workings of Zenoss. I&#8217;ll do my best to explain or link to other documentation
on each item.</p>
<div class="section" id="monitoring-template">
<h4>Monitoring Template</h4>
<p>Monitoring Templates, also called RRD Templates, are the real meat to getting
your performance data displayed. We will be creating one monitoring template.
This template will be used to trend various performance metrics.</p>
</div>
<div class="section" id="command-parser">
<h4>Command Parser</h4>
<p>The whole reason for this document...... We&#8217;ll be running the <em>varnishstat</em>
command over SSH and parsing the output to get all the data to graph. The
<a class="reference external" href="http://community.zenoss.org/community/documentation/official_documentation/zenoss-dev-guide">Zenoss Developer&#8217;s Guide</a> talks about this in section 12.5.2. Its not very
newb friendly so thats where I hope to bridge the gap.</p>
</div>
</div>
<div class="section" id="building-the-pieces">
<h3>Building The Pieces</h3>
<div class="section" id="the-command-parser">
<h4>The Command Parser</h4>
<p>Lets create the file that will hold our new command parser:</p>
<div class="highlight-bash"><div class="highlight"><pre>mkdir /media/zenpack_git_sources/ZenPacks.community.Varnish3/ZenPacks/community/Varnish3/parsers
touch /media/zenpack_git_sources/ZenPacks.community.Varnish3/ZenPacks/community/Varnish3/parsers/VarnishStat.py
</pre></div>
</div>
<p>The contents of my VarnishStat.py contain a good bit more than what I am showing
below, however most of the code in that file is used for the actual parsing
of the varnishstat output and has nothing to do with creating a command parser.
The number of items actually required in the command parser is actually much
smaller than I thought would be required when I started out.</p>
<p>First we start with the necessary imports. There is really only one required:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">Products.ZenRRD.CommandParser</span> <span class="kn">import</span> <span class="n">CommandParser</span>
</pre></div>
</div>
<p>Setup logging. This is technically not required, but Python makes logging
so easy its really a crime to not use it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;zen&#39;</span><span class="p">,</span> <span class="n">__name__</span><span class="p">]))</span>
</pre></div>
</div>
<p>The &#8220;logger =&#8221; line warrants a little explanation. The Python logging module
works some magic with name spaces so an application (in this case ZenCommand) can
decide on a logging namespace. In this case Zenoss uses the zen.* name space.
This means any loggers we create that start with &#8220;zen.&#8221; will automatically inherit
the logging settings already defined by ZenCommand helping us to ensure a
consistent look and feel. The &#8220;__name__&#8221; piece simply appends the module name
onto the logger name. I like to do this so it is crystal clear what module a log
entry came from.</p>
<p>Next we need to create our new command parser class as such:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">VarnishStat</span><span class="p">(</span><span class="n">CommandParser</span><span class="p">):</span>
</pre></div>
</div>
<p>One thing I found the hardware way is that it appears <strong>Zenoss makes some
assumptions that the class name match the module name</strong> (including case). So
as you can see in this example we&#8217;ve created class <strong>VarnishStat</strong> inside of
file <strong>VarnishStat.py</strong>. Notice the matching names and case. Additionally the
class should extend the <em>CommandParser</em> class we imported above.</p>
<p>Now we need to define our single <em>required</em> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">processResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
</pre></div>
</div>
<p>On the surface it looks simple enough, but there is actually alot of magic going
on here. First the method <strong>has</strong> to be called <em>processResults</em>. Additionally
it should accept <em>cmd</em> and <em>result</em> as input paramaters. The two input parameters
which are passed automatically by ZenCommand when it invokes your processResults
method are the keys to success here. I&#8217;ll do my best to describe the important
parts (that I am aware of).</p>
<ul>
<li><p class="first"><strong>cmd</strong> is an instance of the Products.ZenRRD.zencommand.Cmd object.</p>
<ul>
<li><p class="first"><em>cmd.command</em>: This will contain the command line that was executed. This is
useful if you have a command line that might change, or if you need to validate
that proper flags were used.</p>
</li>
<li><p class="first"><em>cmd.points</em>: This is a list of the datapoints being requested from your
monitoring template. This one took me a few minutes to get my head around
so I&#8217;ll go into a bit of detail. I&#8217;ll show you a visual when we talk about
the monitoring template, but for now. Assume our monitoring template is
named <em>Varnish3</em> and our datasource is named <em>Varnish3Stats</em> . We will have
only one datasource, but we will have multiple datapoints (one for each stat).
Lets say we defined two datapoints named <em>cache_hit</em> and <em>cache_miss</em>.</p>
<p>When our <em>processResults</em> is invoked cmd.points will contain two Datapoint
<strong>objects</strong>. If printed they look like:
[({}, &#8216;cache_hit&#8217;), ({}, &#8216;cache_miss&#8217;)]
Its important to understand that these are Datapoint objects, and not
simply strings representing the names of the Datapoints.</p>
</li>
<li><p class="first"><em>cmd.result</em>: Is an object instance which contains additional information
about the results of the executed command.</p>
<ul class="simple">
<li><em>cmd.result.output</em>: This is the text that was returned from the invoked
command. <strong>*This is what you want to parse*</strong>.</li>
<li><em>cmd.result.exitCode</em>: This the return code from the invoked command.
There is a good chance you want to levarage this and only attempting
parsing on a valid return code.</li>
</ul>
</li>
</ul>
</li>
<li><p class="first"><strong>results</strong> is a ParsedResults object which at the time your method is called
contains two empty lists: <em>events</em> and <em>values</em>. These will be populated by
your <em>processResults</em> method. The results object is discussed a bit in
section 12.5.2 of the <a class="reference external" href="http://community.zenoss.org/community/documentation/official_documentation/zenoss-dev-guide">Zenoss Developer&#8217;s Guide</a></p>
<ul>
<li><p class="first"><em>result.events</em>: This is a list which will have the end result of
creating events which will show up in the event console. As you may or
may not use them, I&#8217;m not going to go into alot of detail, but you can
see an example usage in the <em>_errors_found</em> method of the VarnishStat
parser.</p>
</li>
<li><p class="first"><em>result.values</em>: This is the list you&#8217;ll use to return values for each
datapoint which will end up in the actual RRD files. This ends up being
a list of tuples, where each tuple is a datapoint, value pairing. In this
context the datapoint is the actual datapoint object, and not the string
representation of the datapoint name. A very contrived example of this
would look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">cmd</span><span class="o">.</span><span class="n">points</span><span class="p">:</span>
   <span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dp</span><span class="p">,</span> <span class="mi">12345</span><span class="p">))</span>
</pre></div>
</div>
<p>This example is fairly stupid but it illustrates the concept. If you
recall the earlier contents of cmd.points, this would end up assigning the
value &#8220;12345&#8221; to the <em>cache_hit</em> as well as <em>cache_miss</em> datapoints.</p>
<p>In the real world &#8220;12345&#8221; would be replaced with the value of the actual
datapoint and not a static value. You can see this in action toward the tail end
of the <em>processResults</em> method in the <em>VarnishStat</em> parser.</p>
<p>So the simpliest, working version of the parser could look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">Products.ZenRRD.CommandParser</span> <span class="kn">import</span> <span class="n">CommandParser</span>

<span class="k">class</span> <span class="nc">VarnishStat</span><span class="p">(</span><span class="n">CommandParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">processResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
      <span class="c">#Do Some Parsing Code</span>
      <span class="c">#....</span>
      <span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">cmd</span><span class="o">.</span><span class="n">points</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dp</span><span class="p">,</span> <span class="mi">12345</span><span class="p">)</span>
</pre></div>
</div>
<p>Obviously you&#8217;ll want to fill in the parsing code section with real code
and add error checking, but that minimal amount of code could actually do
the trick</p>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="the-monitoring-template">
<h4>The Monitoring Template</h4>
<p>At this point we&#8217;ve got the bare essentials around the command parser. The second
half to making this all work is creating the monitoring template.</p>
<ul>
<li><p class="first">Start by logging into your Zenoss server UI and navigate to
<em>Monitoring Templates</em> section of the GUI:
&#8216;<a class="reference external" href="http://YourServer:8080/zport/dmd/template">http://YourServer:8080/zport/dmd/template</a>&#8216;</p>
</li>
<li><p class="first">Next hit the &#8216;+&#8217; icon in the lower left corner of your screen. This will open
the <em>Add Template</em> dialogue box. Give your template a name, I called mine
<em>Varnish3</em>. Next decide which device class to target. I&#8217;d suggest targeting the
highest level device class that the software you are parsing could run on. As
an example I&#8217;m targeting Varnish3 at <em>/Server/Linux</em>.</p>
<img alt="https://b9m4pw.bay.livefilestore.com/y2p1DGdLNiQEsWrfVELnbYzxYNFSv6lLLYMS8lwyhPXehm4PYtR5t-LkDCysr1nXr-ch3zRWoBzry8oZMgEwVRyiPAEDFGddtkg8xRh8K4VGm4/AddTemplate.png?psid=1" src="https://b9m4pw.bay.livefilestore.com/y2p1DGdLNiQEsWrfVELnbYzxYNFSv6lLLYMS8lwyhPXehm4PYtR5t-LkDCysr1nXr-ch3zRWoBzry8oZMgEwVRyiPAEDFGddtkg8xRh8K4VGm4/AddTemplate.png?psid=1" />
</li>
<li><p class="first">Now you have an empty template. Click the &#8216;+&#8217; icon right under where it says
&#8216;Data Sources&#8217;. This is <strong>not</strong> the same &#8216;+&#8217; you just clicked. This will open the
&#8216;Add Data Source&#8217; dialogue window.</p>
<blockquote>
<div><ul class="simple">
<li>Enter the name for your datasource, in my case it was <em>Varnish3Stats</em>.</li>
<li>Ensure you select a type of <em>COMMAND*</em></li>
</ul>
<img alt="https://b9m4pw.bay.livefilestore.com/y2pmQK9e8ZodZdiqzuYH1BcVGJcRUXl2zdl6flXVDh8CoFbvhs2EBseIzXKIIm2BxTSAfIN0v1TolVhqqp-qH-rBvxqiXKuNwPh05DT_PkbFcw/AddDataSourceButton.png?psid=1" src="https://b9m4pw.bay.livefilestore.com/y2pmQK9e8ZodZdiqzuYH1BcVGJcRUXl2zdl6flXVDh8CoFbvhs2EBseIzXKIIm2BxTSAfIN0v1TolVhqqp-qH-rBvxqiXKuNwPh05DT_PkbFcw/AddDataSourceButton.png?psid=1" />
<img alt="https://b9odhg.bay.livefilestore.com/y2pVN8xE5lPpenp2Oqv1975tmrb3lvj7NrVhrHnRNvJtNS6SxCxdRiembBD69zGBTCVqToSzQWDj0P_t6DEpXiRpltUG1amRz4bkfWs4D2OVOU/AddDataSource.png?psid=1" src="https://b9odhg.bay.livefilestore.com/y2pVN8xE5lPpenp2Oqv1975tmrb3lvj7NrVhrHnRNvJtNS6SxCxdRiembBD69zGBTCVqToSzQWDj0P_t6DEpXiRpltUG1amRz4bkfWs4D2OVOU/AddDataSource.png?psid=1" />
</div></blockquote>
</li>
<li><p class="first">You will now see your new datasource listed in the &#8216;Data Sources&#8217; column.
Double click the newly created data source to enter &#8216;Edit Data Source&#8217; dialogue
window. There are two critical things to complete in this window</p>
<blockquote>
<div><ul class="simple">
<li>First, you need to be certain you select the new parser you just created.
In my case this is <em>ZenPacks.community.Varnish3.parsers.Varnish3Stat</em></li>
<li>Second, you want to populate the &#8216;Command Template&#8217; field with the actual
command you want to run. Its worth mentioning again, <strong>this is the actual command
that will get executed</strong>. In this case its <em>/usr/bin/varnishstat -x</em></li>
<li>One more option to consider is the &#8216;Use SSH&#8217; checkbox. Depending on where you
intend the command to be run, you may or may not want to enable this. In my
case I want the <em>varnishstat</em> command to be executed on the remote host, so
I need to enable that option</li>
</ul>
<img alt="https://b9m4pw.bay.livefilestore.com/y2peFKklL-L3aVdIOkG4_77TJRcHiOnnM3Q6hSqKqPl8xJLELNTx0QhhwRaNJ7o-7qyUTuTuBbuoEqm-7EJ7N4xSWXHotBU6ujClGn4DDveAqU/EditDataSource.png?psid=1" src="https://b9m4pw.bay.livefilestore.com/y2peFKklL-L3aVdIOkG4_77TJRcHiOnnM3Q6hSqKqPl8xJLELNTx0QhhwRaNJ7o-7qyUTuTuBbuoEqm-7EJ7N4xSWXHotBU6ujClGn4DDveAqU/EditDataSource.png?psid=1" />
</div></blockquote>
</li>
<li><p class="first">Once that is saved you will want to hit the small gear icon just about your newly
created datasource and select &#8216;Add Data Point&#8217;. <strong>The name you enter should exactly
match the name of the stat you want to collect</strong>. Repeat this step for <em>each</em> stat
you want to collect. Going back to our earlier example we would add one datapoint
named <em>cache_hit</em> and a second datapoint named <em>cache_miss</em>. If you recall,
these datapoints you are creating here are what is passed as <em>cmd.points</em> to
your <em>processResults</em> method.</p>
<p>There is quite a bit to understand about datapoints which are outside the scope
of this document. At a high level you should understand what the different types
of datapoints do, and when one type is appropriate over another. Be sure to
review section 6.2 of the <a class="reference external" href="http://community.zenoss.org/community/documentation/official_documentation/zenoss-guide">Zenoss Administration</a> guide as it goes into good
details about datapoint types.</p>
</li>
<li><p class="first">You will also want to setup Graph Definitions at this time. This is another topic
that is covered in section 6.2.8 of the <a class="reference external" href="http://community.zenoss.org/community/documentation/official_documentation/zenoss-guide">Zenoss Administration</a> guide so I won&#8217;t
re-hash it. Here is sample of what my completed template looks like:</p>
<img alt="https://b9m4pw.bay.livefilestore.com/y2ppTfTMLp7HwATzwfb2ao3-f5lqF8akvRtQ42q7StnSJYgR16nztu_5-vcGT-MnxwkDn3NP1g6zzvzjKpW6Sts8fevOm8vVYSsNN8xUZR2oeM/CompletedExample.png?psid=1" src="https://b9m4pw.bay.livefilestore.com/y2ppTfTMLp7HwATzwfb2ao3-f5lqF8akvRtQ42q7StnSJYgR16nztu_5-vcGT-MnxwkDn3NP1g6zzvzjKpW6Sts8fevOm8vVYSsNN8xUZR2oeM/CompletedExample.png?psid=1" />
</li>
<li><p class="first">Once you have everything to your liking, we need to add this template to the
ZenPack so it gets exported along with the command parser code we wrote. Using
the gear menu in the lower left of your screen, select &#8216;Add to ZenPack&#8217;. You
will be prompted with a list of ZenPacks that are currently in development mode
(allowing updates). Select the ZenPack you created earlier in this document.
In my case that is <em>ZenPacks.community.Varnish3</em>.</p>
<img alt="https://b9m4pw.bay.livefilestore.com/y2p-mk2JpG3fTJWeWxQTOri2SXZ9zSe3ZJYaZi6IF3xYVANQwc0bv9IgsMXJ5qA4SEVTfHyNahKa-qPSBpVAqzJeEx6gtw03N6TRyp0zNEOj14/AddToZenPack.png?psid=1" src="https://b9m4pw.bay.livefilestore.com/y2p-mk2JpG3fTJWeWxQTOri2SXZ9zSe3ZJYaZi6IF3xYVANQwc0bv9IgsMXJ5qA4SEVTfHyNahKa-qPSBpVAqzJeEx6gtw03N6TRyp0zNEOj14/AddToZenPack.png?psid=1" />
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="pulling-it-all-together">
<h2>Pulling It All Together</h2>
<p>So at this point you have a working command parser. This command parser is
referenced by your new super-cool monitoring template and life is good. At this point
you could bind your monitoring template to a device or device class and assuming
you&#8217;ve got things configured correctly, begin collecting the metrics you&#8217;ve defined
in your monitoring template.</p>
<p>However, your command parser and template are probably too cool to keep to yourself
so you should really share it with the rest of the Zenoss community. At this point
you need to export your ZenPack. This will result in all your custom code and
template(s) being pulled together into a single redistributable file commonly referred
to as an &#8220;EGG&#8221; file. The EGG file is what users (who are not interested in the
source code) will download and install into their own Zenoss installations.</p>
<p>Follow the section &#8216;Install and Test ZenPack in Zenoss&#8217; in
<a class="reference external" href="http://community.zenoss.org/docs/DOC-8495">ZenPack Development Process</a> to export your EGG and get your new ZenPack uploaded
to GitHub.</p>
<p>Thats it!!!. I know there is a lot of information we only briefly touched on but the
reality is Zenoss is a complex beast. No single document can give you all the
information you need, but my hope is that this document is enough information
for those that are familiar with Zenoss to get started writing a custom command
parser.</p>
</div>
</div>

    <div class="postmeta">
        <div class="author">
            <span>Posted by David Petzel</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="../../../categories/zenoss.html">Zenoss</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="../../../tags/zenoss.html">Zenoss</a>, <a href="../../../tags/zenpack.html">ZenPack</a></span>
        </div>
        </div>
    <div id="disqus_thread"></div><script type="text/javascript">    var disqus_shortname = "dpetzel";    var disqus_identifier = "2011/12/16/developing_a_command_parser_based_zenpack";    disqus_thread();</script><noscript>Please enable JavaScript to view the    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><ul class="related clearfix">
            <li class="left"> &laquo; <a href="../../../2012/02/10/converting_zenoss_vmware_virtual_appliance_to_virtualbox.html">Converting Zenoss VMWare Virtual Appliance to VirtualBox</a></li>
            <li class="right"></li>
        </ul></article><aside class="sidebar"><section><div class="widget">
    <h1>Recent Posts</h1>
    <ul><li>
            <a href="../../../2013/10/10/django_1_2_to_1_5_upgrade.html">Django 1.2 to 1.5 Upgrade</a>
        </li><li>
            <a href="../../../2013/10/03/chef_minitest_handler_cookbook_1_0_0_released.html">Chef Minitest Handler Cookbook 1.0.0 Released</a>
        </li><li>
            <a href="../../../2013/09/24/sphinx_with_external_image_annoyance.html">Sphinx With External Image Annoyance</a>
        </li><li>
            <a href="../../../2013/09/23/switched_to_tinkerer.html">Switched To Tinkerer</a>
        </li><li>
            <a href="../../../2013/09/22/adventures_in_django_performance_analysis.html">Adventures in Django Performance Analysis</a>
        </li><li>
            <a href="../../../2013/09/22/chef_minitest_and_slow_starting_web_application.html">Chef Minitest and Slow Starting Web Application</a>
        </li><li>
            <a href="../../../2013/09/08/running_uptime_on_heroku.html">Running Uptime on Heroku</a>
        </li><li>
            <a href="../../../2013/09/08/hello_pelican.html">Hello Pelican</a>
        </li><li>
            <a href="../../../2013/09/07/publishing_a_zenoss_zenpack_to_pypi_using_travis_ci.html">Publishing A Zenoss ZenPack to PyPi Using Travis-CI</a>
        </li><li>
            <a href="../../../2013/09/03/live_with_mynt.html">Live With Mynt</a>
        </li></ul>
</div>
</section><section><div class="widget" id="searchbox">
    <h1>Search</h1>
    <form action="../../../search.html" method="get">
        <input type="text" name="q" />
        <button type="submit"><span class="webfont">L</span></button>
    </form>
</div></section></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container"><footer class="wrapper">&copy; Copyright 2013, David Petzel. Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.</footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>